/**
 * Écran de détails d'un enregistrement pour validation
 * 
 * Route dynamique : /admin/validation/[id]
 * 
 * Cet écran sera utilisé à l'avenir pour remplacer le modal de détails.
 * Il s'adapte automatiquement selon le type d'enregistrement (pregnancy/birth).
 * 
 * Usage:
 * router.push(`/admin/validation/${recordId}`)
 */

import { PressableButton } from '@/components/PressableButton';
import { ScreenContainer } from '@/components/ScreenContainer';
import {
  ThemedCard,
  ThemedText,
  ThemedView
} from '@/components/ThemedComponents';
import { HAITIAN_DEPARTMENTS } from '@/constants/departments';
import { useResponsive } from '@/hooks/useResponsive';
import { useTranslation } from '@/hooks/useTranslation';
import { useLanguageStore } from '@/store/languageStore';
import { useTheme } from '@/theme';
import { FontAwesome } from '@expo/vector-icons';
import { useLocalSearchParams, useRouter } from 'expo-router';
import React, { useEffect, useState } from 'react';
import { ScrollView, StyleSheet } from 'react-native';
import { useSafeAreaInsets } from 'react-native-safe-area-context';

interface RecordDetails {
  id: string;
  type: 'pregnancy' | 'birth';
  referenceNumber: string;
  date: string;
  recordedBy: string;
  recordedByType: 'agent' | 'hospital' | 'admin';
  status: 'pending' | 'validated' | 'rejected';
  // ... tous les détails complets
}

export default function ValidationDetailsScreen() {
  const router = useRouter();
  const theme = useTheme();
  const { isTablet } = useResponsive();
  const t = useTranslation();
  const insets = useSafeAreaInsets();
  const { language } = useLanguageStore();
  const { id } = useLocalSearchParams<{ id: string }>();
  const [record, setRecord] = useState<RecordDetails | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // TODO: Fetch record details from API using id
    // const fetchRecord = async () => {
    //   try {
    //     const data = await api.get(`/validation/${id}`);
    //     setRecord(data);
    //   } catch (error) {
    //     console.error('Error fetching record:', error);
    //   } finally {
    //     setLoading(false);
    //   }
    // };
    // fetchRecord();
    
    // Pour l'instant, simulation
    setLoading(false);
  }, [id]);

  const handleBack = () => {
    router.back();
  };

  const handleValidate = () => {
    // TODO: Validate record
    router.back();
  };

  const handleReject = () => {
    // TODO: Open reject modal or navigate to reject screen
    router.back();
  };

  // Helper functions (same as in index.tsx)
  const getDepartmentName = (code?: string) => {
    if (!code) return '-';
    const dept = HAITIAN_DEPARTMENTS.find(d => d.code === code);
    return dept ? (language === 'ht' ? dept.nameKr : dept.name) : code;
  };

  const formatNames = (firstNames?: string[], lastName?: string) => {
    if (!firstNames || firstNames.length === 0) return lastName || '-';
    if (!lastName) return firstNames.join(' ');
    return `${firstNames.join(' ')} ${lastName}`;
  };

  if (loading) {
    return (
      <ScreenContainer variant="background">
        <ThemedView variant="transparent" style={styles.loadingContainer}>
          <ThemedText>{t('common.loading') || 'Chargement...'}</ThemedText>
        </ThemedView>
      </ScreenContainer>
    );
  }

  if (!record) {
    return (
      <ScreenContainer variant="background">
        <ThemedView variant="transparent" style={styles.errorContainer}>
          <ThemedText>{t('admin.validation.notFound') || 'Enregistrement non trouvé'}</ThemedText>
          <PressableButton
            onPress={handleBack}
            label={t('common.back')}
            variant="primary"
          />
        </ThemedView>
      </ScreenContainer>
    );
  }

  return (
    <ScreenContainer variant="background">
      {/* Header */}
      <ThemedView
        variant="transparent"
        style={StyleSheet.flatten([
          styles.header,
          {
            backgroundColor: theme.colors.primary,
            paddingTop: Math.max(insets.top, 16),
          }
        ])}
      >
        <PressableButton
          onPress={handleBack}
          icon="arrow-left"
          variant="ghost"
          style={styles.backButton}
        />
        <ThemedView variant="transparent" style={styles.headerText}>
          <ThemedText size="lg" weight="bold" style={{ color: '#fff' }}>
            {t('admin.validation.details') || 'Détails'}
          </ThemedText>
          <ThemedText size="sm" style={{ color: '#fff', opacity: 0.9 }}>
            {record.referenceNumber}
          </ThemedText>
        </ThemedView>
      </ThemedView>

      <ScrollView
        style={styles.scrollContent}
        contentContainerStyle={isTablet && styles.scrollContentTablet}
        showsVerticalScrollIndicator={false}
      >
        {/* Contenu adaptatif selon record.type */}
        {record.type === 'pregnancy' ? (
          // Afficher détails de grossesse
          <PregnancyDetails record={record} />
        ) : (
          // Afficher détails de naissance
          <BirthDetails record={record} />
        )}

        {/* Actions si pending */}
        {record.status === 'pending' && (
          <ThemedView variant="transparent" style={styles.actionsContainer}>
            <PressableButton
              onPress={handleReject}
              label={t('admin.validation.reject') || 'Rejeter'}
              variant="outline"
              style={StyleSheet.flatten([
                styles.actionButton,
                { borderColor: theme.colors.error }
              ])}
              labelStyle={{ color: theme.colors.error }}
            />
            <PressableButton
              onPress={handleValidate}
              label={t('admin.validation.validate') || 'Valider'}
              variant="primary"
              style={styles.actionButton}
            />
          </ThemedView>
        )}
      </ScrollView>
    </ScreenContainer>
  );
}

// Composants séparés pour chaque type
function PregnancyDetails({ record }: { record: RecordDetails }) {
  // Afficher toutes les informations de grossesse
  return (
    <>
      {/* Informations de la mère */}
      {/* Informations de grossesse */}
    </>
  );
}

function BirthDetails({ record }: { record: RecordDetails }) {
  // Afficher toutes les informations de naissance
  return (
    <>
      {/* Informations de l'enfant */}
      {/* Informations de la mère */}
      {/* Informations du père */}
      {/* Informations des témoins */}
    </>
  );
}

const styles = StyleSheet.create({
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  errorContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    gap: 16,
    padding: 32,
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 16,
    paddingVertical: 16,
    gap: 12,
  },
  backButton: {
    // Styles pour le bouton retour
  },
  headerText: {
    flex: 1,
  },
  scrollContent: {
    flex: 1,
    padding: 16,
  },
  scrollContentTablet: {
    maxWidth: 900,
    alignSelf: 'center',
    width: '100%',
  },
  actionsContainer: {
    flexDirection: 'row',
    gap: 12,
    marginTop: 24,
    marginBottom: 32,
  },
  actionButton: {
    flex: 1,
  },
});

